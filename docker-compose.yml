name: travel-advisor

services:
    database:
        image: postgres:15
        environment:
            POSTGRES_DB: directus
            POSTGRES_USER: directus
            POSTGRES_PASSWORD: directus
            POSTGRES_MULTIPLE_DATABASES: directus,n8n
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
            - ./init-travel-schema.sql:/docker-entrypoint-initdb.d/init-travel-schema.sql
            - ./init-chat-schema.sql:/docker-entrypoint-initdb.d/init-chat-schema.sql
        ports:
            - "5432:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U directus -d directus"]
            interval: 10s
            timeout: 5s
            retries: 5

    directus:
        image: directus/directus:11.5.1
        ports:
            - 8055:8055
        volumes:
            - ./uploads:/directus/uploads
            - ./extensions:/directus/extensions
        environment:
            SECRET: "a9f8b7c6d5e4f3g2h1i0j9k8l7m6n5o4p3q2r1s0t9u8v7w6x5y4z3a2b1c0d9e8f7g6h5i4j3k2l1m0"
            KEY: "b9f8c7d6e5f4g3h2i1j0k9l8m7n6o5p4q3r2s1t0u9v8w7x6y5z4a3b2c1d0e9f8g7h6i5j4k3l2m1n0"
            ADMIN_EMAIL: "admin@example.com"
            ADMIN_PASSWORD: "d1r3ctu5"
            DB_CLIENT: "pg"
            DB_HOST: "database"
            DB_PORT: "5432"
            DB_DATABASE: "directus"
            DB_USER: "directus"
            DB_PASSWORD: "directus"
            WEBSOCKETS_ENABLED: "true"
            CORS_ENABLED: "true"
            CORS_ORIGIN: "*"
            CORS_METHODS: 'GET,POST,PATCH,DELETE'
            EXTENSIONS_AUTO_RELOAD: "true"
            NODE_ENV: "development"
            CACHE_SCHEMA: "false"
        depends_on:
            database:
                condition: service_healthy

    ollama:
        image: ollama/ollama:latest
        ports:
            - "11434:11434"
        volumes:
            - ollama_data:/root/.ollama
        environment:
            - OLLAMA_HOST=0.0.0.0

    n8n:
        image: n8nio/n8n:latest
        ports:
            - "5678:5678"
        environment:
            - N8N_BASIC_AUTH_ACTIVE=true
            - N8N_BASIC_AUTH_USER=admin
            - N8N_BASIC_AUTH_PASSWORD=admin123
            - N8N_HOST=0.0.0.0
            - N8N_PORT=5678
            - N8N_PROTOCOL=http
            - DB_TYPE=postgresdb
            - DB_POSTGRESDB_HOST=database
            - DB_POSTGRESDB_PORT=5432
            - DB_POSTGRESDB_DATABASE=n8n
            - DB_POSTGRESDB_USER=n8n
            - DB_POSTGRESDB_PASSWORD=n8n
        volumes:
            - n8n_data:/home/node/.n8n
            - "./Chat llm chain.json:/home/node/.n8n/workflows/chat-workflow.json"
        depends_on:
            database:
                condition: service_healthy

    travel-search-frontend:
        build:
            context: ../travel-search-frontend
            dockerfile: Dockerfile
        ports:
            - "3000:80"
        container_name: travel-search-frontend
        restart: unless-stopped
        environment:
            - NODE_ENV=production
            - VITE_DIRECTUS_URL=http://localhost:8055
        depends_on:
            - directus

volumes:
    postgres_data:
    ollama_data:
    n8n_data:
